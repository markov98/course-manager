const jwt = require("jsonwebtoken");
const db = require('../config/db')
const { SECRET } = require("../constants");

exports.login = async (username, password) => {
    const stmt = db.prepare('SELECT id, username, username, password FROM users WHERE username = ?');
    const user = stmt.get(username);

    if (!user) {
        throw new Error('Incorrect username or password');
    }


    if (password !== user.password) {
        throw new Error('Incorrect username or password');
    }

    return getResult(user);
};


function getResult(user) {
    const payload = { _id: user.id, email: user.email };
    const token = jwt.sign(payload, SECRET, { expiresIn: "1h" });
    const result = {
        _id: user.id,
        accessToken: token,
        email: user.email,
    };

    return result;
}